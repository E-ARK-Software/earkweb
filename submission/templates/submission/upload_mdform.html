{% extends "earkweb/base.html" %}

{% load static %}
{% load i18n %}

{% load widget_tweaks %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

<link rel="stylesheet" href="{% static 'earkweb/leaflet/leaflet.css' %}" />
 <!--link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/-->

 <!-- Make sure you put this AFTER Leaflet's CSS -->
<script src="{% static 'earkweb/leaflet/leaflet.js' %}"></script>
 <!--script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script-->


<script type="text/javascript" src="{% static 'submission/js/submission.js' %}"></script>
<style>
#locations, label[for="locations"] {
    display: none;
}
#locations {
    display: none;
}
.cdt-tags-list-value {
  display: inline-block;
  padding: 0;
  margin: 2px;
}

.cdt-tags-list-value .selection-label {
    background: #f0efe6;
    border: 1px solid #e5e5dc;
    border-radius: 10px;
    color: #000000;
    font-size: 16px;
    line-height: 12px;
    padding: 8px 20px 8px;
}

.cdt-tags-list-value .selection-label:after{
  content:"\00d7";
  padding-left:5px;
  color:#666666;
  font-weight:600;
}

.cdt-tags-list-value .selection-label:hover {
  background-color: #EEE;
  cursor: pointer;
}

</style>

{% if "step2" in request.path %}
<script>
    const existingLocations = JSON.parse("{{ locations | escapejs }}");
    console.log(existingLocations)
</script>

<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script>
function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0,
              v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}
function MapLocation(label, lat, lng, zoomLevel, locationUncertainty=0, locationUncertaintyRadius=0, locationEvent="", locationDate="") {
    this.identifier = "urn:eark:location:" + generateUUID();
    this.label = label;
    this.coordinates = { lat: lat, lng: lng };
    this.zoomLevel = zoomLevel;
    this.locationUncertainty = locationUncertainty;
    this.locationUncertaintyRadius = locationUncertaintyRadius;
    this.eventIdentifier = "urn:eark:event:" + generateUUID();
    this.locationEvent = locationEvent;
    this.locationDate = locationDate;
}
MapLocation.prototype.toString = function() {
    return JSON.stringify({
        identifier: this.identifier,
        label: this.label,
        coordinates: this.coordinates,
        zoomLevel: this.zoomLevel,
        locationUncertainty: this.locationUncertainty,
        locationUncertaintyRadius: this.locationUncertaintyRadius,
        eventIdentifier: this.eventIdentifier,
        locationEvent: this.locationEvent,
        locationDate: this.locationDate
    });
};
MapLocation.fromString = function(str) {
    const obj = JSON.parse(str);
    return new MapLocation(
        obj.identifier,
        obj.label,
        obj.coordinates.lat,
        obj.coordinates.lng,
        obj.zoomLevel,
        obj.locationUncertainty,
        obj.locationUncertaintyRadius,
        obj.eventIdentifier,
        obj.locationEvent,
        obj.locationDate
    );
};

function persistLocations() {
    let persistedLocationsArr = [];

    for (const [key, value] of Object.entries(window.locationsRecord)) {
        if (value instanceof MapLocation) {
            persistedLocationsArr.push(value.toString());
        }
    }

    let persistedLocations = persistedLocationsArr.length > 0 ? "[" + persistedLocationsArr.join(", ") + "]" : "[]";

    $('#locations').val(persistedLocations);
    console.log("Updated persisted locations:", $('#locations').val());
}


$(document).on("click", "#update_location_btn", function () {
    let oldLabel = $("#location").attr("data-original-label"); // Track the old name
    let newLabel = $("#location").val();
    let eventName = $("#event_name").val();
    let eventDate = $("#event_date").val();
    let locationUncertainty = $("#locslider").slider("value");

    let location;

    if (oldLabel in window.locationsRecord) {
        location = window.locationsRecord[oldLabel];
    } else {
        for (const key in window.locationsRecord) {
            if (window.locationsRecord[key].marker.getLatLng().lat === window.currentLocation.marker.getLatLng().lat &&
                window.locationsRecord[key].marker.getLatLng().lng === window.currentLocation.marker.getLatLng().lng) {
                location = window.locationsRecord[key];
                break;
            }
        }
    }

    if (location) {
        delete window.locationsRecord[oldLabel];

        location.label = newLabel;
        location.locationEvent = eventName;
        location.locationDate = eventDate;
        location.locationUncertainty = locationUncertainty;

        window.locationsRecord[newLabel] = location;

        location.marker.setTooltipContent(newLabel);

        persistLocations();
        window.map.closePopup();
    }
});

$(document).on("click", "#toggle_event_btn", function () {
    let eventDetailsDiv = $("#event_details");

    if (eventDetailsDiv.is(":visible")) {
        eventDetailsDiv.slideUp();
        $(this).text("+ Add event details");
    } else {
        eventDetailsDiv.slideDown();
        $(this).text("- Hide event details");
    }
});

$(document).on("click", "#delete_location_btn", function () {
    let locationLabel = $("#location").val();
    let location = window.locationsRecord[locationLabel];

    console.log("Attempting to delete location:", locationLabel);

    if (location) {
        console.log("Location found in window.locationsRecord:", location);

        if (location.marker && map.hasLayer(location.marker)) {
            console.log("Removing marker...");
            map.removeLayer(location.marker);
            location.marker = null; 
        }
        if (location.circle && map.hasLayer(location.circle)) {
            console.log("Removing circle...");
            map.removeLayer(location.circle);
            location.circle = null;
        }

        delete window.locationsRecord[locationLabel];
    } 

    if (window.currentLocation && window.currentLocation.marker) {
        console.log("Removing window.currentLocation marker...");
        if (map.hasLayer(window.currentLocation.marker)) {
            map.removeLayer(window.currentLocation.marker);
        }
        window.currentLocation.marker = null;
    }

    if (window.currentLocation && window.currentLocation.circle) {
        console.log("Removing window.currentLocation circle...");
        if (map.hasLayer(window.currentLocation.circle)) {
            map.removeLayer(window.currentLocation.circle);
        }
        window.currentLocation.circle = null;
    }

    window.currentLocation = {};

    persistLocations(); 
    window.map.closePopup();
});


$(document).on("click", "#add_location_btn", function () {
    handleLocationEvent(); 
    window.map.closePopup(); 
});

function handleLocationEvent() {
    let locationLabel = $("#location").val();
    let eventName = $("#event_name").val();
    let eventDate = $("#event_date").val();
    let locationUncertainty = $("#locslider").slider("value");

    if (!locationLabel) {
        alert("Please enter a location name.");
        return;
    }

    if (window.locationsRecord[locationLabel]) {
        let existingLocation = window.locationsRecord[locationLabel];
        existingLocation.locationUncertainty = locationUncertainty;
        existingLocation.locationEvent = eventName;
        existingLocation.locationDate = eventDate;

        existingLocation.marker.setTooltipContent(locationLabel);

        if (existingLocation.circle) {
            map.removeLayer(existingLocation.circle);
        }
        existingLocation.circle = L.circle([existingLocation.marker.getLatLng().lat, existingLocation.marker.getLatLng().lng], {
            color: 'blue',
            fillColor: 'blue',
            fillOpacity: 0.3,
            radius: existingLocation.locationUncertaintyRadius
        }).addTo(map);
    } else {
        // Create a new location object
        let loc = new MapLocation(
            locationLabel,
            window.currentLocation.lat,
            window.currentLocation.lng,
            window.currentLocation.zoomLevel,
            locationUncertainty,
            window.currentLocation.locationUncertaintyRadius,
            eventName,
            eventDate
        );

        // Create marker
        loc.marker = L.marker([window.currentLocation.lat, window.currentLocation.lng], {
            title: locationLabel,
            draggable: true
        }).addTo(map);

        loc.marker.bindTooltip(locationLabel, { permanent: true, direction: 'right' });

        // Create uncertainty circle
        loc.circle = L.circle([window.currentLocation.lat, window.currentLocation.lng], {
            color: 'blue',
            fillColor: 'blue',
            fillOpacity: 0.3,
            radius: window.currentLocation.locationUncertaintyRadius
        }).addTo(map);

        // Store the new location
        window.locationsRecord[locationLabel] = loc;

        // Click event for editing
        loc.marker.on("click", function (e) {
            openEditContextMenu(e, loc);
        });

        // Enable dragging and updating position
        loc.marker.on("dragend", function (e) {
            loc.coordinates.lat = e.target.getLatLng().lat;
            loc.coordinates.lng = e.target.getLatLng().lng;
            persistLocations();
        });
    }

    persistLocations();
    window.map.closePopup(); // Ensure the popup closes after adding the location
}

$(document).on("contextmenu", function () {
    $("#event_details").show();
    $("#toggle_event_btn").text("- Hide event details");
});

function openEditContextMenu(e, location) {
    L.popup()
        .setLatLng(e.latlng)
        .setContent(`
            <div class="form-group ui-widget">
                <label for="location">Location name</label>
                <input style="width:200px" class="form-control" id="location" type="text" value="${location.label}" data-original-label="${location.label}" />

                <label for="locslider">Location uncertainty</label>
                <div style="margin-left:2px;margin-bottom:10px" id="locslider"></div>

                <!-- Button to toggle event details -->
                <button class="btn btn-secondary btn-sm" type="button" id="toggle_event_btn">
                    ${location.locationEvent ? "- Hide event details" : "+ Add event details"}
                </button>

                <!-- Event details (initially hidden) -->
                <div id="event_details" style="display: ${location.locationEvent ? "block" : "none"}; margin-top: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <label for="event_name">Event name</label>
                    <input style="width:200px" class="form-control" id="event_name" type="text" value="${location.locationEvent}" />

                    <label for="event_date">Event date</label>
                    <input style="width:200px" class="form-control" id="event_date" type="date" value="${location.locationDate}" />
                </div>

                <button id="update_location_btn" class="btn btn-primary" type="button">Save Changes</button>
                <button id="delete_location_btn" class="btn btn-danger" type="button">Delete</button>
            </div>
        `)
        .addTo(map)
        .openOn(map);

    // Update slider
    $("#locslider").slider({
        range: "min",
        min: 0,
        max: 100,
        value: location.locationUncertainty,
        change: function (event, ui) {
            location.locationUncertainty = ui.value;
            if (location.circle) {
                map.removeLayer(location.circle);
            }
            location.circle = L.circle([location.marker.getLatLng().lat, location.marker.getLatLng().lng], {
                color: 'blue',
                fillColor: 'blue',
                fillOpacity: 0.3,
                radius: (200000 / Math.pow(2, location.zoomLevel)) * ui.value
            }).addTo(map);
        }
    });
}


</script>
{% endif %}

{% if "step1" in request.path or "modify" in request.path %}
<script>

$(document).ready(function() {
let update_hidden_tags = function() {
        let selected_values = [];
        console.log($('#pp').siblings('.cdt-tags-list').find('.cdt-tags-list-values').children());
        $('#pp').siblings('.cdt-tags-list').find('.cdt-tags-list-values').children().each(function() {
            selected_values.push({
            'custom': $(this).data('custom'),
            'value': $(this).text()
            });
        });
        $('#pp_tags_hidden').val(JSON.stringify(selected_values));
    };

let addTagClickHandlers = function() {
        // Add a click event to remove the item again.
      $('.cdt-tags-list-value').unbind('click').click(function() {
        let $this = $(this);
        if ($this.siblings().length === 0) {
        }
        $this.remove();
        update_hidden_tags();
      });
    };

    $( ".cdt-tags-list-value" ).click(function() {
        let $this = $(this);
        if ($this.siblings().length === 0) {
        }
        $this.remove();
        update_hidden_tags();
      });

    //$(function() {
    let tags_input = $("#pp");

        tags_input.autocomplete({
            source: "{% url 'submission:get_autocomplete' %}",
            minLength: 2,
            delay: 500,
            select: function (event, ui) {
                //$(this).closest().siblings('.cdt-tags-list');
                this.value = '';
                let value_selection = $(this).siblings('.cdt-tags-list');
                if (value_selection.find('.cdt-tags-list-value').filter(function(index) {return ($(this).text() === ui.item.value);}).length === 0) {
                  value_selection.children('.cdt-tags-list-values').append('<div class="cdt-tags-list-value" data-custom="false"><div class="selection-label">' + ui.item.label + '</div></div>');
                  addTagClickHandlers();
                }
                update_hidden_tags();
                return false;
              }
        });
        tags_input.keydown(function(e) {
                if(e.keyCode === 13){
                    e.preventDefault();
                   $(this).siblings('.cdt-tags-list').children('.cdt-tags-list-values').append('<div class="cdt-tags-list-value" data-custom="true"><div class="selection-label">' + $(this).val() + '</div></div>');
                   addTagClickHandlers();
                   $(this).val('');
                   update_hidden_tags();
                   return false;
                }
        });
    //});
});
</script>
{% endif %}

{% if "step4" in request.path %}
<style>
/* Basic styling for the button */
#hoverButton {
    padding: 10px 20px;
    font-size: 16px;
    cursor: pointer;
}

/* Styling for the popup */
.popup {
    display: none;
    position: absolute;
    background-color: white;
    border: 1px solid black;
    padding: 10px;
    box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
}

/* Optional: styling for the popup when visible */
.popup.visible {
    display: block;
}
</style>
<script>
function loadDataFiles(ipTargetDirectory) {

    $.ajax({
        type: 'GET',
        url: '/earkweb/api/ips/{{ ip.uid }}/dir-json',
        data: {

        },
        success: function(data){
            console.log(JSON.stringify(data));
            var targetDir = data.data.children.filter(obj => {
              return obj.text === ipTargetDirectory;
            })

            var datafiles = targetDir[0]['children'];
            console.log(datafiles.length);

            initPrev = [];
            initPrevConfig = [];

            if(datafiles.length > 0) {

                var datafiles_arr = datafiles;

                var mimeTypes = [];

                var pv_file_paths = [];
                function appendFilePaths(path, dfarr) {
                    for (df of dfarr) {
                        var curr_path = path ? path+"/"+df.text : df.text;
                        if(!df.children) {
                            pv_file_paths.push(curr_path);
                            mimeTypes.push(df.data);
                        } else {

                            appendFilePaths(curr_path, df.children);
                        }
                    }
                }
                appendFilePaths(null, datafiles_arr);
                pv_file_paths.sort();
                obj = [];
                for (var key in mimeTypes) {
                    console.log('Download URL: {{ django_backend_service_url }}/submission/fileresource/'+ mimeTypes[key]['path']);
                    var downloadUrl = '{{ django_backend_service_url }}/submission/fileresource/'+ mimeTypes[key]['path'];
                    var deleteUrl = '{{ django_backend_service_url }}/submission/fileresource/'+ mimeTypes[key]['path']+'/';
                    caption = mimeTypes[key]['path'].replace('{{ ip.uid }}/'+ipTargetDirectory+'/', '');
                    initPrev.push(mimeTypes[key]['mimetype']);
                    console.log(mimeTypes[key]['path'].replace('{{ ip.uid }}/'+ipTargetDirectory+'/', ''));
                    initPrevConfig.push({caption: caption, filetype: mimeTypes[key]['mimetype'], downloadUrl: downloadUrl, key: mimeTypes[key]['path'], previewAsData: false, 'showPreview': false, url: deleteUrl});
                }

            }

            $("#kv-explorer").fileinput({
                minFileCount: 1,
                maxFileCount: 50,
                maxFileSize: 102400,
                'allowedFileExtensions' : ['csv', 'jpg', 'jpeg', 'jfif', 'tif', 'tiff', 'png', 'gpx', 'pdf', 'osm', 'ods',
'odt', 'docx', 'doc', 'xml', 'txt', 'xls', 'xlsx', 'ppt', 'pptx', 'json', 'jsonl', 'gml', 'xsd', 'mp3', 'wav', 'zip'],
                'theme': 'explorer-fa',
                'uploadUrl': '/earkweb/submission/ip_upload',
                overwriteInitial: false,
                allowedPreviewTypes: ['image'],
                initialPreviewAsData: false,
                initialPreview: initPrev,
                initialPreviewConfig: initPrevConfig,
                preferIconicPreview: true, // this will force thumbnails to display icons for following file extensions
                previewFileIconSettings: { // configure your icon file extensions
                'doc': '<i class="fas fa-file-word text-primary"></i>',
                'odt': '<i class="fas fa-file-word text-primary"></i>',
                'xls': '<i class="fas fa-file-excel text-primary"></i>',
                'ods': '<i class="fas fa-file-excel text-primary"></i>',
                'ppt': '<i class="fas fa-file-powerpoint text-primary"></i>',
                'pdf': '<i class="fas fa-file-pdf text-primary"></i>',
                'zip': '<i class="fas fa-file-archive text-primary"></i>',
                'htm': '<i class="fas fa-file-code text-primary"></i>',
                'txt': '<i class="fas fa-file-alt text-primary"></i>',
                'md': '<i class="fas fa-file-alt text-primary"></i>',
                'mov': '<i class="fas fa-file-video text-primary"></i>',
                'mp3': '<i class="fas fa-file-audio text-primary"></i>',
                'csv': '<i class="fas fa-file-csv text-primary"></i>',
                'xml': '<i class="fas fa-file-code text-primary"></i>',
                'json': '<i class="fas fa-file-code text-primary"></i>',
                'gml': '<i class="fas fa-atlas text-primary"></i>',
                'xsd': '<i class="fas fa-file-code text-primary"></i>',
                'shp': '<i class="fas fa-atlas text-primary"></i>',
                'shx': '<i class="fas fa-atlas text-primary"></i>',
                'sql': '<i class="fas fa-database text-primary"></i>',

                // note for these file types below no extension determination logic
                // has been configured (the keys itself will be used as extensions)
                'jpg': '<i class="fas fa-file-image text-danger"></i>',
                'gif': '<i class="fas fa-file-image text-muted"></i>',
                'png': '<i class="fas fa-file-image text-primary"></i>'
            },
            previewFileExtSettings: { // configure the logic for determining icon file extensions
                'csv': function(ext) {
                    return ext.match(/(csv)$/i);
                },
                'doc': function(ext) {
                    return ext.match(/(doc|docx)$/i);
                },
                'ods': function(ext) {
                    return ext.match(/(ods)$/i);
                },
                'odt': function(ext) {
                    return ext.match(/(odt)$/i);
                },
                'xls': function(ext) {
                    return ext.match(/(xls|xlsx)$/i);
                },
                'ppt': function(ext) {
                    return ext.match(/(ppt|pptx)$/i);
                },
                'zip': function(ext) {
                    return ext.match(/(zip|rar|tar|gzip|gz|7z|xz)$/i);
                },
                'htm': function(ext) {
                    return ext.match(/(htm|html)$/i);
                },
                'txt': function(ext) {
                    return ext.match(/(txt|ini|java|php|js|css)$/i);
                },
                'mov': function(ext) {
                    return ext.match(/(avi|mpg|mkv|mov|mp4|3gp|webm|wmv)$/i);
                },
                'mp3': function(ext) {
                    return ext.match(/(mp3|wav)$/i);
                }
            },
                uploadExtraData: function (previewId, index) {
                var info = {
                    "uid": "{{ ip.uid }}",
                    "distribution_description": $('#id_distribution_description').val(),
                    "offer": $('#id_offer').val(),
                    "access_rights": $('#id_access_rights').val(),
                };
                return info;
                }
            });

            $('button[title="View Details"]').css("display", "none");
            $('span[title="Move / Rearrange"]').css("display", "none");


        },
        error: function(data){
            window.console.log("an error occurred");
        }
    });
}

$(document).ready(function() {
    var documentationIpTargetDirectory = "documentation";
    loadDataFiles(documentationIpTargetDirectory);
});
</script>
{% endif %}


{% if "step2" in request.path %}
<script>
$(document).ready(function() {

    // leaflet map initialisation
    // set up the map
    window.map = new L.Map('map');

    // create the tile layer with correct attribution
    var osmUrl='http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
    var osmAttrib='Map data © <a href="http://openstreetmap.org">OpenStreetMap</a> contributors';
    var osm = new L.TileLayer(osmUrl, {minZoom: 2, maxZoom: 20, attribution: osmAttrib});

    // start the map in the first existing location
    if(existingLocations.length > 0) {
        var firstLocation = existingLocations[0];
        if (
            firstLocation &&
            firstLocation.coordinates &&
            typeof firstLocation.coordinates.lat === 'number' &&
            typeof firstLocation.coordinates.lng === 'number'
        ) {
            // Extract coordinates and zoom level
            const lat = firstLocation.coordinates.lat;
            const lng = firstLocation.coordinates.lng;
            const zoom = firstLocation.zoomLevel || 11; // Default zoom level if none is provided

            // Zoom the map to the location
            map.setView(new L.LatLng(lat, lng), zoom);
        } else {
            console.error('Invalid or missing coordinates in firstLocation.');
        }
    } else {
        // start in Vienna if there is still no location
        map.setView(new L.LatLng(48.26909, 16.42686),11);
    }
    
    map.addLayer(osm);

    // Add the geocoder control to the map
    var geocoder = L.Control.geocoder({
            defaultMarkGeocode: false
        })
        .on('markgeocode', function(e) {
            var bbox = e.geocode.bbox;
            var poly = L.polygon([
                bbox.getSouthEast(),
                bbox.getNorthEast(),
                bbox.getNorthWest(),
                bbox.getSouthWest()
            ]).addTo(map);
            map.fitBounds(poly.getBounds());
        })
        .addTo(window.map);


    // location object
    const Location = {
      label: "",
      lat: 0.0,
      lng: 0.0,
      zoomLevel: 0,
      locationUncertainty: 0,
      locationUncertaintyRadius: 0,
      locationEvent: "",
      locationDate: "",
      marker: undefined,
      circle: undefined
    };

    // existing markers
    const jsEscape = (string) => {
      return string.replace(new RegExp("'", 'g'),"\\'");
    };

    const decodeUnicodeEntities = (data) => {
      return unescape(jsEscape(data));
    };

    // current map objects
    window.currentLocation = Object.create(Location);
    window.locationsRecord = {};

    if(existingLocations.length > 0) {
        for (const item of existingLocations) {
            var currLoc = new MapLocation(
                item.label,
                item.coordinates.lat,
                item.coordinates.lng,
                item.zoomLevel,
                item.locationUncertainty,
                item.locationUncertaintyRadius,
                item.locationEvent,
                item.locationDate
            );

            currLoc.marker = L.marker([item.coordinates.lat, item.coordinates.lng], {
                title: item.label,
                draggable: true
            }).addTo(map);

            currLoc.marker.bindTooltip(item.label, { permanent: true, direction: 'right' });

            currLoc.circle = L.circle([item.coordinates.lat, item.coordinates.lng], {
                color: 'blue',
                fillColor: 'blue',
                fillOpacity: 0.3,
                radius: item.locationUncertaintyRadius
            }).addTo(map);

            window.locationsRecord[item.label] = currLoc;

            // Enable clicking to edit
            currLoc.marker.on("click", function (e) {
                openEditContextMenu(e, currLoc);
            });

            // Enable dragging and updating position
            currLoc.marker.on("dragend", function (e) {
                currLoc.coordinates.lat = e.target.getLatLng().lat;
                currLoc.coordinates.lng = e.target.getLatLng().lng;
                persistLocations();
            });
        }
    }

    // context menu html
    let html = `
        <div class="form-group ui-widget">
            <label for="location">Location name</label>
            <input style="width:200px" class="form-control ui-autocomplete-input" id="location" type="text" value=""/>
            
            <label for="locslider">Location uncertainty</label>
            <div style="margin-left:2px;margin-bottom:10px" id="locslider"></div>

            <!-- Button to toggle event details -->
            <button class="btn btn-secondary btn-sm" type="button" id="toggle_event_btn">
                + Add event details
            </button>

            <!-- Event details (initially hidden) -->
            <div id="event_details" style="display: none; margin-top: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                <label for="event_name">Event name</label>
                <input style="width:200px" class="form-control" id="event_name" type="text" />
                
                <label for="event_date">Event date</label>
                <input style="width:200px" class="form-control" id="event_date" type="date" />
            </div>

            <button id="add_location_btn" class="btn btn-primary" type="button">Add location</button>
        </div>
    `;
    
    // map context menu
    map.on('contextmenu',(e) => {
        L.popup()
        .setLatLng(e.latlng)
        .setContent(html)
        .addTo(map)
        .openOn(map);

        

        // marker
        window.currentLocation.marker = L.marker([e.latlng.lat, e.latlng.lng], {
           title: "undefined",
           clickable: true,
           draggable: true
        }).addTo(map);
        window.currentLocation.marker.bindTooltip("undefined", { permanent: true, direction: 'right' });
        window.currentLocation.lat = e.latlng.lat;
        window.currentLocation.lng = e.latlng.lng;
        window.currentLocation.zoomLevel = e.target._zoom;

        // set location label
        $( "#location" ).on( "keyup", function(e) {
            window.currentLocation.marker.setTooltipContent($('#location')[0].value);
            window.currentLocation.label = $('#location')[0].value
        });

        // slider (location uncertainty)
        $( function(e) {
            $( "#locslider" ).slider({
            range:"min",
              min: 0,
              max: 100,
              value: 10,
                change: function( event, ui ) {
                    createCircle(ui.value);
                    window.currentLocation.locationUncertainty = ui.value;
                }
            });
        });

        function createCircle(radiusFactor) {
            if (window.currentLocation.circle != undefined) {
                map.removeLayer(window.currentLocation.circle);
            }
            var r = (200000/Math.pow(2, window.currentLocation.zoomLevel)) * radiusFactor;
            window.currentLocation.locationUncertaintyRadius = r;
            window.currentLocation.circle = L.circle([e.latlng.lat, e.latlng.lng], {
                color: 'blue',
                fillColor: 'blue',
                fillOpacity: 0.3,
                radius: r
                }).addTo(map);

        };
    });

    

    // slider
    $( function() {
        $( "#slider" ).slider();
    });
    if($('#locations').val() === "") {
        $('#locations').val('{}')
    }
});
</script>
{% endif %}


<link rel="stylesheet" href="{% static "submission/css/submission.css" %}" type="text/css" />

<link rel="stylesheet" href="{% static "submission/css/start.css" %}" type="text/css" />


<style>
    #map { height: 600px; }
</style>


{% endblock %}

{% block content %}


{% if "step1" in request.path %}
<h2>{% trans 'Information package metadata' %}</h2>
{% elif "step2" in request.path %}
<h2>{% trans 'Geospatial metadata' %}</h2>
{% elif "step3" in request.path %}
<h2>{% trans 'Contact metadata' %}</h2>
{% elif "step4" in request.path %}
<h2>{% trans 'Supplementary Documentation' %}</h2>
{% else %}
<h2>{% trans 'Metadata' %}</h2>
{% endif %}

{% if "step2" in request.path %}
<p>{% trans 'Right click on the map to add a location. Move the "location uncertainty" slider to create a circle for the area of the location. On the top right of the map you can search for a location.' %}</p>
{% endif %}

{% if "step4" in request.path %}

<p>{% trans 'Upload <b>supplementary documentation</b> necessary to understand, manage, and preserve the digital information contained within the package. The files will be <b>stored in the "documentation" folder</b> of the information package. (see CSIPSTR16 related to the <a href="https://earkcsip.dilcis.eu/#folderstructureofthecsip">folder structure of the E-ARK CSIP</a>).' %}</p>
{% endif %}

<form name="mdform" method="post">
    {% csrf_token %}

    {% for hidden in form.hidden_fields %}
    {{ hidden }}
    {% endfor %}

    {% for field in form.visible_fields %}
    {% if field.name == 'tags' %}
    <div class="form-group ui-widget">

        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {% render_field field class="form-control" %}
        <div class="cdt-tags-list"><div id="taglist" class="cdt-tags-list-values">
            {% for tag in tags %}
            <div class="cdt-tags-list-value" data-custom="false"><div class="selection-label">{{ tag }}</div></div>
            {% endfor %}
            {% for tag in user_generated_tags %}
            <div class="cdt-tags-list-value" data-custom="true"><div class="selection-label">{{ tag }}</div></div>
            {% endfor %}
        </div></div>
        {% for error in field.errors %}
        <span class="help-block">{{ error }}</span>
        {% endfor %}
    </div>
    {% else %}
    <div class="form-group">
        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {% render_field field class="form-control" %}
        {% for error in field.errors %}
            <div class="alert alert-danger">
                <strong>{{ error|escape }}</strong>
            </div>
        {% endfor %}
        {% for error in form.non_field_errors %}
        <div class="alert alert-danger">
            <strong>{{ error|escape }}</strong>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endfor %}

    {% if "step2" in request.path %}
    <div class="form-group">
        <label style="display:block; margin-top:10px" for="map">Locations</label>
        <div id="map"></div>
        <p style="font-style: italic">Right click to add locations.</p>
        <label for="locations">Latitude/Longitude/Location uncertainty</label>
        <input class="form-control ui-autocomplete-input" type="text" id="locations" name="locations" value="{{ locations }}">
    </div>
    {% endif %}

    {% if "step4" in request.path %}
        <input type="hidden" name="packagename" value="{{ ip.package_name }}"/>
        <input type="hidden" name="uid" value="{{ ip.uid }}"/>
        <input type="hidden" name="pk" value="{{ pk }}"/>
        <input type="hidden" name="rep" value="{{ rep }}"/>
        <div class="file-loading">
            <input id="kv-explorer" type="file" multiple data-min-file-count="0">
        </div>
        <div id="popup" class="popup">Make sure to upload all data files before continuing!</div>

    {% endif %}

    {% if form.errors %}
    {% for field in form %}
        {% for error in field.errors %}
            <div class="alert alert-danger">
                {% if field.name == 'hidden_user_tags' %}
                <strong>Tags: {{ error|escape }}</strong>
                {% else %}
                <strong>{{ field.label }}: {{ error|escape }}</strong>
                {% endif %}
            </div>
        {% endfor %}
    {% endfor %}
    {% endif %}

    <div class="form-group">
        <button id="continuebtn" type="submit" class="btn btn-primary">
            <span class="glyphicon glyphicon-triangle-right"></span> {% trans 'Continue' %}
        </button>
        <a href="{% url 'submission:overview' %}" class="btn btn-eark">{% trans 'Cancel' %}</a>
    </div>
</form>

<script src="https://unpkg.com/@webcomponents/webcomponentsjs@2.0.0/webcomponents-bundle.js"></script>



<script type="text/javascript" src="{% static 'earkweb/tagify/tagify.min.js' %}"></script>
<link rel="stylesheet" href="{% static "earkweb/tagify/tagify.css" %}" type="text/css" />

<script type="text/javascript">
    $(document).ready(function () {
        // Initialize the datepicker
        $('#id_original_creation_date').datepicker({
            dateFormat: 'dd.mm.yy',
            changeYear: true,
            yearRange: '-200:+00'
        });

        // Ensure it opens on click
        $('#id_original_creation_date').on('focus', function () {
            $(this).datepicker('show');
        });
    });
</script>

{% if "step4" in request.path %}
<script>
$(document).ready(function() {
    const $button = $('#continuebtn');
    const $popup = $('#popup');

    $button.hover(
        function() {
            // Get button's position and dimensions
            const rect = this.getBoundingClientRect();
            const popupWidth = $popup.outerWidth();
            const popupHeight = $popup.outerHeight();

            // Position the popup above the button (or adjust as needed)
            $popup.css({
                left: `${(rect.left / 2) + (rect.width / 2) - (popupWidth / 2)-16}px`,
                top: `${rect.top - popupHeight - 130}px`
            });

            // Show the popup
            $popup.addClass('visible');
        },
        function() {
            // Hide the popup
            $popup.removeClass('visible');
        }
    );
});
</script>
{% endif %}

{% endblock %}

{% block after_body %}
{% endblock %}
