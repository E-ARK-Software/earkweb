{% extends "earkweb/base.html" %}

{% load static %}
{% load i18n %}
{% block extra_head %}

    <!-- Submission area javascript -->
    <script type="text/javascript" src="{% static 'submission/js/submission.js' %}"></script>
    <link rel="stylesheet" href="{% static "submission/css/submission.css" %}" type="text/css" />

    <link rel="stylesheet" href="{% static "submission/css/start.css" %}" type="text/css" />

{% endblock %}

{% block content %}

    {% include "submission/about_module.html" %}

    <h2>{% trans 'NavNewSubmission' %}</h2>

    <p>{% trans 'EnterInternalLabelAndOptionalExternalId' %}</p>

    <div class="standard-form-container">

        <form class="form-horizontal" method="POST" action="{% url 'submission:initialize' %}">
            {% csrf_token %}

                <div class="form-group">

                    <label for="packagename" class="control-label col-xs-3">{% trans 'Label' %}</label>
                    <div class="col-xs-6">
                        <input type="text" class="form-control" id="packagename" name="packagename" placeholder="PACKAGE.NAME.000" value="{{ ip.package_name }}" data-toggle="tooltip" title="The submission name serves as an identifier for the submission.">
                    </div>

                </div>

                <div class="form-group">

                    <label for="extuid" class="control-label col-xs-3">{% trans 'External identifier (optional)' %}</label>
                    <div class="col-xs-6">
                        <input type="text" class="form-control" id="extuid" name="extuid" placeholder="10.1000/182" value="{{ ip.extuid }}" data-toggle="tooltip" title="Optionally provide an external unique identifier. The identifier must be a valid URI.">
                    </div>

                </div>

                <div class="form-group">
                    <div style="height:1em" class="col-xs-offset-3 col-xs-10">
                        <span class="errmsg" id="msgpackagename"></span>
                    </div>
                </div>

                <div class="form-group">
                    <div class="col-xs-offset-3 col-xs-10">
                        <button id="initialize" type="submit" class="btn btn-primary">{% trans 'Continue' %}</button>
                    </div>
                </div>

        </form>

    </div>

    <script type="text/javascript">
        /**
         * Start creating SIP
         */
        (function(){

        function setValid(elmid) {
            $( "#"+elmid ).removeClass("error");
            $( "#"+elmid ).addClass("ok");
            $('#initialize').removeAttr("disabled");
        }

        function setInvalid(elmid) {
            $( "#"+elmid ).addClass("error");
            $( "#"+elmid ).removeClass("ok");
            $('#initialize').attr("disabled", "disabled");
        }

        $('#initialize').attr("disabled", "disabled");
        
        function checkPackageName(successCallback) {
            var pn = $( "#packagename" );
            var check_folder_url = "/earkweb/check_submission_exists/" + pn.val()
            window.console.log(check_folder_url);
            if (pn.val().length < 3) {
                $( "#msgpackagename" ).html("The package name must consist of at least 3 characters!");
                setInvalid("packagename");
                return false;
            } else {
                $( "#msgpackagename" ).html("");
                var regex = new RegExp('^[a-zA-Z0-9\.\\-_]*$');
                if(!regex.test(pn.val())) {
                    $( "#msgpackagename" ).html("Invalid characters in submission name!");
                    setInvalid("packagename");
                    return false;
                } else {


                    $.ajax({
                        type: "GET",
                        url: check_folder_url,
                        success: function (folder_exists) {
                            if(folder_exists == 'true') {
                                $( "#msgpackagename" ).html("A submission with this name already exists, please choose another name!");
                                setInvalid("packagename");
                            } else {
                                $( "#msgpackagename" ).html("");
                                setValid("packagename");
                                successCallback();
                            }
                        }
                    });

                }
            }
        }
        /**
         * Continously check if folder for data set exists
         */
        $( "#packagename" ).keyup(function() {
        checkPackageName(function() {});
        }).focus(function() {
        checkPackageName(function() {});
        });
        const uriPattern = /^(https?:\/\/[^\s/$.?#].[^\s]*|(?:doi:)?\d{2}\.\d{4,9}\/[-._;()/:a-zA-Z0-9]+|(?:handle:)?[^\s]+|info:[^\s]+)$/i;
        function validateURI(uri) {
            return uriPattern.test(uri);
        }
        $( "#extuid" ).keyup(function() {
            var isValidURI = validateURI($(this).val());
            window.console.log(isValidURI);
            if($(this).val() == '' || isValidURI) {
                setValid("extuid");
            } else {
                setInvalid("extuid");
            }
        });
        })();

    </script>

{% endblock %}
