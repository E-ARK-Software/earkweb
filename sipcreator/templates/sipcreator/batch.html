{% extends "earkweb/base.html" %}
{% load dictionary_extras %}

{% load staticfiles %}

{% block extra_head %}

    <script type="text/javascript" src="/static/earkweb/earkweb/jquery-1.11.2/jquery-1.11.2.js"></script>
    <script type="text/javascript" src="/static/earkweb/earkweb/jquery-1.11.2/jquery.form.min.js"></script>

    <!-- SIP creator javascript -->
    <script type="text/javascript" src="{% static 'sipcreator/js/sipcreator.js' %}"></script>

    <!-- Polling -->
    <script type="text/javascript" src="{% static 'earkcore/js/polling.js' %}"></script>

    <!-- batch.html stylesheet -->
    <link rel="stylesheet" href="{% static "sipcreator/css/batch.css" %}" type="text/css" />

    <script type="text/javascript" src="{% static 'js/base.js' %}"></script>

    <script language="JavaScript">
    function enable_predef_idmap_def_div() {
        $('#predef_idmap_def').togglevisible();
    }
    $(".div_enabler").each(function() {
    $(this).attr("data-oldhref", $(this).attr("href"));
    $(this).removeAttr("href");
});

    </script>

{% endblock %}

{% block content %}

    {% include "sipcreator/about_module.html" %}

    <h2 class="main">Batch SIP creation</h2>

    <p>Run SIP creation for selected SIPs. </p>

    <button id="batch-apply-task" type="submit" class="btn btn-primary" onclick="return false" >Run batch SIP creation!</button></p>

    <table id="receptiontable" class="table table-striped table-bordered table-condensed">
    <thead>
      <tr>
		<th class="filecol">Package file</th>
		<th class="daticol">Date/time</th>
        <th class="statcol">Last task</th>
        <th class="statcol">Status</th>
          <th class="statcol">Processing</th>
        <th class="statcol">Selected</th>
      </tr>
    </thead>
    <tbody id="iplist">
        {% for ip in sips %}
            <tr>
                <td><a href="{% url 'sip2aip:ip_detail' ip.pk %}" title='Detail information'>{{ ip.packagename }}</a></td>
                <td>{{ ip.last_change|date:"d.m.Y H:i:s" }}</td>
                <td>{{ ip.last_task }}</td>
                <td>{{ StatusProcess_CHOICES|access:ip.statusprocess }} ({{ ip.statusprocess }})
			{% if ip.statusprocess == 0 %}
                 <span class="glyphicon glyphicon-ok-sign" aria-hidden="true" style="color:green"/>
			{% elif ip.statusprocess == 2 %}
				<span class="glyphicon glyphicon-warning-sign" aria-hidden="true" style="color:#F6A50B"/>
                {% else %}
                <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true" style="color:#91170A"/>
                {% endif %}
			</td>
            <td><span id="st{{ ip.uuid }}" class="label label-default received">None</span></td>
            <td><input id="ip{{ ip.uuid }}" name="ipselect" value="{{ ip.uuid }}" type="checkbox" checked="checked"/></td>
            </tr>
        {% endfor %}
    </tbody>
  </table>

    <script language="JavaScript">
        var selected = Array();
        //$('#batch-apply-task').attr("disabled", "disabled");
        function changeLabel(labelid, oldlabel, newlabel, newlabeltext) {
            $(labelid).removeClass(oldlabel.toLowerCase());
            $(labelid).addClass(newlabel.toLowerCase());
            $(labelid).text(newlabeltext);
        }
        function run_all() {
            $('#batch-apply-task').prop('disabled', true);
              $("input:checkbox[name=ipselect]:checked").each(function() {
                   selected.push($(this));
              });
              for(var i=0; i<selected.length; i++) {
                window.console.log(selected[i].val());
                var uuid = selected[i].val();
                uuid_label_id = '#st'+uuid;
                changeLabel(uuid_label_id, "None", "Submitted", "Submitted");
                $('#ip'+uuid).attr("disabled", "disabled");
                $.ajax({
                url: "/earkweb/sipcreator/submit_sipcreation_batch/" +  uuid + "/",
                method: "POST",
                async: true,
                data: { },
                success: function(json_result) {
                    var proc_pack_status_id = '#st'+json_result.uuid;
                    changeLabel(proc_pack_status_id, "Submitted", "Processing", "Processing");
                },
                });
              }
        }
        $('#batch-apply-task').click(run_all);
    </script>
{% endblock %}


